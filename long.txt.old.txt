<?php
//Pathogen Collab (2410 Edition)
//Copyright © 2010 by Pathogen Studios
//http://www.pathogenstudios.com/
//
//===About Pathgogen Collab===
//Pathogen Collab is a minimalistic content management system indtended for team collaboration
//developed by "Pathogen" David Maas in 2010 for collaboration of projects by Pathogen Studios
//he also developed it with the intention that it would be used by the FIRST Robotics Team 2334
//(now merged with team 2410.) It has an emphasis of simplicity and flatness rather than general-
//ized customization. The theme is fixed and the plugin system is very basic. It also only works
//with one SQL engine (MySQL) as it uses it directly rather than abstracting it.
//
//===About this edition===
//This version was prepared for FRC Team 2410 prior to the 2011 FIRST season (December 2010)
//It was developed and maintained by David Maas, if you are having any issues with the system
//please do not hesitate to contact me. I can be reached at contact@pathogenstudios.com

require_once("System/system.php");

$eventTypes = array(
'commit'=>'view_more_text.png',
'bug'=>'error_fuck.png',
'taskadd'=>'add_small.png',
'assign'=>'contact_grey_add.png',
);

require_once("Modules/recentActivity.php");
require_once("Modules/tasks.php");
require_once("Modules/meetings.php");
require_once("Modules/homePage.php");
require_once("Modules/directory.php");
require_once("Modules/firstCountdown.php");
require_once("Modules/checkin.php");

//Restrict Page
if (!empty($_SESSION['restrictpage']) && getPage()!=$_SESSION['restrictpage'])
{
 $rpage = $_SESSION['restrictpage'];
 logout();
 message("This page is restricted, you have been logged out.",1);
 setPage($rpage);
 die;
}

//Page choosing logic.
if (getPage()=="task")
{taskPage();}
else if (getPage()=="account")
{accountPage();}
else if (getPage()=="meetings")
{message("Work in progress.",1);}
else if (getPage()=="meetingman")
{meetingManPage();}
else if (getPage()=="directory")
{directoryPage();}
else if (getPage()=="rss")
{
 define('DISABLE_PAGE_THEME',1);
 header("Content-Type: application/rss+xml");
 echo(gadget_recentActivity(true));
 die;
}
else if (getPage()=="checkin")
{checkinPage();}
else if (getPage()=="announce")
{makeAnnouncementPage();}
else if (getPage()=="activity" && canViewRecentActivity($currentUser['rank']))
 {
  echo(gadget_recentActivity());
 }
else
{homePage();}
?>
<?php
//Pathogen Collab
//Copyright © 2010 by Pathogen Studios
//http://www.pathogenstudios.com/

//Output buffering begin!
ob_start();
$pageTitle = "";

require_once("config.php");

//Utility Functions
function getMode() {return @$_POST['mode'];}
function getPage() {return @$_GET['p'];}
function getAction() {return @$_GET['a'];}
function setPage($newPage) {$_GET['p']=$newPage;}
function sqlFilter($data) {return mysql_real_escape_string($data);}
function htmlFilter($data) {return htmlspecialchars($data);}
function today() {return mktime(0,0,0);}
function tonight() {return mktime(23,59,59);}
if(_DEBUG)
{
 function sqlError($result,$sql="")
 {
  if (!$result)
  {message("MySQL Error:<br>".mysql_error().($sql&&_SUPERDEBUG?"<br><br>Query:<br>".htmlspecialchars($sql):""),1);return true;}else{return false;}
 }
}
else
{function sqlError($result,$sql="") {return !$result;}}

$_monthShortNames = array("Jan"=>1,"Feb"=>2,"Mar"=>3,"Apr"=>4,"May"=>5,"Jun"=>6,"Jul"=>7,"Aug"=>8,"Sep"=>9,"Oct"=>10,"Nov"=>11,"Dec"=>12);
function getMonthNumberFromShortName($month)
{
 global $_monthShortNames;
 if (empty($_monthShortNames[$month]))
 {message("FATAL: Unknown month '".$month."' please report this!",1);return 1;}
 else
 {return $_monthShortNames[$month];}
}

function formatPhoneNumber($ph) {return substr($ph,1,3)."-".substr($ph,4,3)."-".substr($ph,7,4);}//15551232410 to 555-123-2410
function unformatPhoneNumber($ph)//555-123-2410 (etc) to 15551232410 or NULL on unrecognized.
{
 if (preg_match('/\+?(\d{1,3})?[-.]?(\d{3})[-.]?(\d{3})[-.]?(\d{4})/',$ph,$matches))
 {
  if (empty($matches[1])) {$matches[1]="1";}
  return $matches[1].$matches[2].$matches[3].$matches[4];
 }
 else
 {return null;}
}

//Generic render functions
function message($message,$error=false,$centered=false)
{
 echo('<div class="'.($error?'redbox':'tintedbox').' floatbreaker'.($centered?' center':'').'">'.$message.'</div>');
}

$noNavBar = false;
function outputHeader($pageTitle="")
{
?>
<!DOCTYPE HTML>
<html>
<head>
 <meta http-equiv="content-type" content="text/html; charset=UTF-8">
 <title><?php echo("Pathogen Collab" . (empty($pageTitle)?"":" - ".$pageTitle)); ?></title>
 <link href="Content/style.css" rel="stylesheet" type="text/css">
 <script type="text/javascript" src="content/script.js"></script>
 <!--[if IE]>
 <link href="Content/iefixes.css" rel="stylesheet" type="text/css">
 <![endif]-->
</head>
<body>
 <a href="/" class="logo"></a>
<?php
 global $noNavBar;
 if (empty($noNavBar))
 {include("navBar.php");}
}

function outputFooter()
{
?>
 <div class="copyright">
  Pathogen Collab is copyright &copy; 2010 by <a href="http://www.pathogenstudios.com/">Pathogen Studios</a><br>
  This version was developed for <a href="http://www.mmr2410.com/">FRC Team 2410</a>
  <?php
  $network = "";
  switch($_SERVER['REMOTE_ADDR'])
  {
   case '76.92.202.42': $network = "D-NET";break;
   case '10.0.0.99': $network = "D-COM";break;
   case '12.187.58.129': $network = "Blue Valley High School";break;
   case '204.52.179.199': $network = "Center for Advanced Professional Studies";break;
  }
  if ($network!="") {echo("<br>Detected Location: ".$network);}
  ?>
 </div>
<?php
if (_SUPERDEBUG)
{
 echo('<div class="tintedbox center floatbreaker"><h3>Debug Info</h3></div>');
 $sdStyle = "width:250px;margin:10px;overflow:auto;min-height:500px;";
 echo('<div class="tintedbox floatleft" style="'.$sdStyle.'"><pre>$_SESSION = '.var_export($_SESSION,true).'</pre></div>');
 echo('<div class="tintedbox floatleft" style="'.$sdStyle.'"><pre>$_COOKIE = '.var_export($_COOKIE,true).'</pre></div>');
 echo('<div class="tintedbox floatleft" style="'.$sdStyle.'"><pre>$_GET = '.var_export($_GET,true).'</pre></div>');
 //Censor passwords in $_POST
 $protectedNames = array('password','pass','passkey','password1','password2','password_current');
 foreach($protectedNames as $name)
 {
  if (isset($_POST[$name]))
  {
   $_POST[$name] = str_repeat("*",strlen($_POST[$name]));
  }
 }
 echo('<div class="tintedbox floatleft" style="'.$sdStyle.'"><pre>$_POST = '.var_export($_POST,true).'</pre></div>');
 echo('<div class="tintedbox floatleft" style="'.$sdStyle.'"><pre>$_SERVER = '.var_export($_SERVER,true).'</pre></div>');
}
?>
</body>
</html>
<?php
}

function outputPage()
{
 global $pageTitle;
 $data = ob_get_clean();
 if (!defined('DISABLE_PAGE_THEME')) {outputHeader($pageTitle);}
 echo($data);
 if (!defined('DISABLE_PAGE_THEME')) {outputFooter();}
}
register_shutdown_function('outputPage');

//Session logic
$oldsessname = session_name();
session_name(_COOKIE_PREFIX.$oldsessname);
session_start();

//Database logic
$db = mysql_connect(_SQL_SERVER,_SQL_USERNAME,_SQL_PASSWORD);
mysql_select_db(_SQL_DATABASE);

//Define SQL Tables
define('USER_TABLE',_SQL_PREFIX.'users');
define('TASK_TABLE',_SQL_PREFIX.'tasks');

require_once("System/user.php");
enforceLoginLogic();

//Special mail function
require_once("class.xhttp.php");
function sendMail($to,$subject,$message,$additional_headers="",$additional_parameters="")
{
 if (_USE_MAIL_PROXY)//PROXY EMAIL IS MUCH SLOWER AS IT TIES UP THE PROGRAM!
 {
  set_time_limit(0);
  $data=array();
  $data['post'] = array(
   'authid' => _MAIL_PROXY_AUTH,
   'to' => $to,
   'subject' => $subject,
   'message' => $message,
   'additional_headers' => $additional_headers,
   'additional_parameters' => $additional_parameters,
  );
  $response = xhttp::fetch(_MAIL_PROXY,$data);
  set_time_limit(ini_get("max_execution_time"));//Restore the max execution time.
  //echo("<pre>");print_r($response['body']);echo("</pre>");
  if ($response['successful'])
  {
   if (substr($response['body'],0,1)=="1")
   {return true;}
   else
   {return false;}
  }else {return false;}
 }
 else
 {return mail($to,$subject,$message,$additional_headers,$additional_parameters);}
}
?><?php
//Pathogen Collab
//Copyright © 2010 by Pathogen Studios
//http://www.pathogenstudios.com/

define('_SQL_SERVER','localhost');
define('_SQL_USERNAME','rodney555');
define('_SQL_PASSWORD','1nn0c3nts_Twa1n');
define('_SQL_DATABASE','2410collab');
define('_SQL_PREFIX','');

define('_COOKIE_PREFIX','pc_');

define('_USERNAME_PREFIX',"Pathogen ");//An optional prefix to certain usernames. //This is not actually used by the 2410 website, but it allows my internal name to be "Pathogen David Maas" and log in as "David Maas"
define('_DEFAULT_USER_RANK',25);//25 - Unconfirmed users -- This is the default when registered, not guest. Guests are assumed to be 0. //See permissions config for more details.
define('_REQUIRE_LOGIN',true);
define('_ALLOW_REGISTRATION',true);
define('_DEBUG',substr_count($_SERVER['HTTP_HOST'],"d-happy")>=1?true:false);//The condition makes it so _DEBUG is on when I am in my home network. //Change "d-happy" to the internal hostname of your server.
define('_SUPERDEBUG',_DEBUG);
define('_ADMIN_EMAIL','pathogendavid@gmail.com');//I would appreciate if you set up a forward email in the 2410 1&1 admin panel so I still get admin messages so I can track RODNEY's usage and success rates.
define('_SYSTEM_EMAIL','rodney2410@pathogenstudios.com');

include_once("Config/repo.php");

include_once("Config/google.php");

define('_LONG_DATE','F j, Y');
define('_LONG_DATE_TIME','F j, Y \a\t g:i');
define('_SHORT_DATE','M j, Y');

define('NL',"\n");

//Checkin Rules
define('CHECKIN_MAX',10);//Maximum hours before they are denied.

//Mail Settings //If you can get sendmail working on your network, then all power to you. If not, you can keep the mail proxy there but don't abuse it.
define('_USE_MAIL_PROXY',1);//Slower but less of a hassle -- using this until a better method is available.
define('_MAIL_PROXY','http://www.pathogenstudios.com/mp/mailProxy.php');
define('_MAIL_PROXY_AUTH','drat@a?7nA4afed!a_a+ubrut8udrax_z#che?3ud&uWus*@freQu_!echa!Hafu');

//Permission logic
require_once("Config/permissions.php");

//Style constants
define('_PROGRESSBAR_WIDTH',800);
?>
<?php
//Pathogen Collab
//Copyright © 2010 by Pathogen Studios
//http://www.pathogenstudios.com/

//! The home page
function homePage()
{
 global $currentUser;
 if (isLoggedIn()) {message('<h1 class="center">Welcome, '.$currentUser['name'].'</h1>'.gadget_countdown(false),0,1);}
 //echo(gadget_tasks());
 if ($currentUser['rank']<50)
 {
  message("Your account has not been validated, so you will not be able to use most of the features until it is.");
 }
 if (canViewRecentActivity($currentUser['rank']))
 {
  //echo(gadget_recentActivity());
 }
}
?>